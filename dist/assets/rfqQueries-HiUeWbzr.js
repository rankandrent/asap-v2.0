import{h as s}from"./index-BaYg4v0E.js";const g=async()=>{try{const t=await fetch("https://ipapi.co/json/",{method:"GET",headers:{Accept:"application/json"}});if(!t.ok)throw new Error("Failed to fetch location data");const e=await t.json();return e.error?(console.warn("IP API Error:",e.reason),d()):{ip:e.ip||"Unknown",city:e.city||"Unknown",state:e.region||"Unknown",country:e.country_name||"Unknown",countryCode:e.country_code||"XX",isUSA:e.country_code==="US",timezone:e.timezone||"Unknown",latitude:e.latitude||0,longitude:e.longitude||0,isp:e.org||"Unknown"}}catch(t){return console.error("Location tracking error:",t),d()}},d=()=>{const t=Intl.DateTimeFormat().resolvedOptions().timeZone,e=t.includes("America/")||t.includes("US/");return{ip:"Unknown",city:"Unknown",state:"Unknown",country:e?"United States":"Unknown",countryCode:e?"US":"XX",isUSA:e,timezone:t,latitude:0,longitude:0,isp:"Unknown"}},w=()=>({userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,screenResolution:`${window.screen.width}x${window.screen.height}`,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}),p=async(t,e)=>{const a=await g(),o=w(),i={...t,source_page:e.sourcePage,source_url:e.sourceUrl,referrer:e.referrer,user_agent:e.userAgent||o.userAgent,status:"new",ip_address:a?.ip,city:a?.city,state:a?.state,country:a?.country,country_code:a?.countryCode,is_usa:a?.isUSA,timezone:a?.timezone||o.timezone,latitude:a?.latitude,longitude:a?.longitude,isp:a?.isp},{data:c,error:u}=await s.from("rfqs").insert([i]).select().single();return{data:c,error:u}},y=async t=>{let e=s.from("rfqs").select("*").order("created_at",{ascending:!1});t?.status&&(e=e.eq("status",t.status)),t?.startDate&&(e=e.gte("created_at",t.startDate)),t?.endDate&&(e=e.lte("created_at",t.endDate)),t?.limit&&(e=e.limit(t.limit));const{data:a,error:o}=await e;return{data:a,error:o}},_=async(t,e)=>{const{data:a,error:o}=await s.from("rfqs").update({status:e}).eq("id",t).select().single();return{data:a,error:o}},f=async()=>{try{const{data:t,error:e}=await s.from("rfqs").select("*").order("created_at",{ascending:!1});if(e)return{data:null,error:e};const a=new Date,o=new Date(a.getFullYear(),a.getMonth(),a.getDate()),i=new Date(o.getTime()-10080*60*1e3),c=new Date(o.getTime()-720*60*60*1e3);return{data:{total_rfqs:t?.length||0,rfqs_today:t?.filter(n=>new Date(n.created_at)>=o).length||0,rfqs_this_week:t?.filter(n=>new Date(n.created_at)>=i).length||0,rfqs_this_month:t?.filter(n=>new Date(n.created_at)>=c).length||0,by_status:t?.reduce((n,r)=>(n[r.status]=(n[r.status]||0)+1,n),{})||{},by_page:t?.reduce((n,r)=>(n[r.source_page]=(n[r.source_page]||0)+1,n),{})||{},by_date:Object.entries(t?.reduce((n,r)=>{const l=new Date(r.created_at).toISOString().split("T")[0];return n[l]=(n[l]||0)+1,n},{})||{}).map(([n,r])=>({date:n,count:Number(r)})).sort((n,r)=>n.date.localeCompare(r.date)).slice(-30),conversion_rate:t?.length?(t?.filter(n=>n.status==="won").length||0)/t.length*100:0,average_quantity:t?.length?t.reduce((n,r)=>n+(r.quantity||0),0)/t.length:0,top_parts:Object.entries(t?.reduce((n,r)=>(r.part_number&&(n[r.part_number]=(n[r.part_number]||0)+1),n),{})||{}).map(([n,r])=>({part:n,count:Number(r)})).sort((n,r)=>r.count-n.count).slice(0,10)},error:null}}catch(t){return{data:null,error:t}}};export{f as a,y as g,p as s,_ as u};
